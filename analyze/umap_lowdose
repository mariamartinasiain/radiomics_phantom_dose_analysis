import pandas as pd
import matplotlib.pyplot as plt
from datetime import datetime
import numpy as np
from tqdm import tqdm
from matplotlib.lines import Line2D
import umap.umap_ as umap
import os
from sklearn.preprocessing import StandardScaler

def load_data(filepath):
    """Loads data and converts deep features into numerical format."""
    data = pd.read_csv(filepath)

    feature_column='deepfeatures'

    if feature_column in data.columns and data[feature_column].dtype == 'object':
        data[feature_column] = data[feature_column].apply(lambda x: np.fromstring(x.strip("[]"), sep=','))
        max_len = data[feature_column].apply(len).max()
        feature_df = pd.DataFrame(data[feature_column].tolist(), index=data.index)
        feature_df.columns = [f"feature_{i}" for i in range(max_len)]
        data = pd.concat([data.drop(columns=[feature_column]), feature_df], axis=1)

    features = data.drop(columns=['StudyInstanceUID', 'SeriesNumber', 'SeriesDescription', 
                                'ROI', 'ManufacturerModelName', 'Manufacturer', 
                                'SliceThickness', 'SpacingBetweenSlices', 'FileName',
                                'StudyID', 'StudyDescription', 'Dose'], errors='ignore')

    # Convert string representation of lists into actual lists
    if features.columns[0] == 'deepfeatures':
        # Clean null bytes before eval
        features['deepfeatures'] = features['deepfeatures'].astype(str).str.replace('\x00', '', regex=False)
        try:
            features = features['deepfeatures'].apply(eval).apply(pd.Series)
        except SyntaxError as e:
            print(f"Error processing {filepath}: {e}")
            raise

    return data, features


def features_to_numpy(features):
    """Converts features into a NumPy array for UMAP."""
    try:
        features_array = np.zeros([len(features), len(features['deepfeatures'].iloc[0])])
    except:
        return np.array(features)
    for i, row in enumerate(features['deepfeatures']):
        features_array[i] = row
    return features_array

def perform_umap(features):
    """Performs UMAP dimensionality reduction."""
    features_array = features_to_numpy(features)  # Assuming you have a function that converts features to numpy
    features_scaled = StandardScaler().fit_transform(features_array)
    umap_reducer = umap.UMAP(n_neighbors=20, min_dist=1, n_components=2, random_state=24)
    umap_results = umap_reducer.fit_transform(features_scaled)
    print(f'Number of samples being plotted: {umap_results.shape[0]}')
    return umap_results

def plot_results(features, labels, data, color_mode, output_dir, filename_suffix=""):
    """Plots the UMAP results with color coding based on ROI, Manufacturer, and Dose."""
    base_filename = f"{output_dir}/{filename_suffix}"

    # Perform UMAP
    umap_results = perform_umap(features)

    # Determine unique labels and assign colors
    unique_labels = sorted(labels.unique())

    print(color_mode)
    
    if 'roi' in color_mode.lower():
        colors = plt.get_cmap('viridis', len(unique_labels))
    elif 'dose' in color_mode.lower():
        colors = plt.get_cmap('coolwarm', len(unique_labels))

    plt.figure(figsize=(8, 6))
    for i, label in enumerate(unique_labels):
        mask = labels == label
        plt.scatter(umap_results[mask, 0], umap_results[mask, 1], 
                    color=colors(i), label=label)

    # Capitalization logic for title:
    if 'roi' in color_mode.lower():
        formatted_color_mode = color_mode.upper()  # All capital letters for ROI
        plt.legend(loc="upper center", bbox_to_anchor=(0.5, 1.15), ncol=8)
    elif 'dose' in color_mode.lower():
        formatted_color_mode = color_mode.capitalize()  # Capitalize the first letter for Dose
        plt.legend(loc="upper center", bbox_to_anchor=(0.5, 1.15), ncol=2)

    if filename_suffix == 'pyradiomics':
        formatted_suffix = filename_suffix.capitalize()
    elif filename_suffix == 'cnn' or filename_suffix == 'ct-fm':
        formatted_suffix = filename_suffix.upper()
    else:
        formatted_suffix = 'SwinUNETR'

    # Customize the title based on color_mode and filename_suffix
    #title = f"UMAP Projection {formatted_suffix} - Colored by {formatted_color_mode} (N={umap_results.shape[0]})"
    title = f"UMAP Projection {formatted_suffix} - Colored by {formatted_color_mode}"
    plt.title(title)

    plt.grid(True)

    # Save the figure with color_mode and filename_suffix in the filename
    plt.savefig(f"{base_filename}_{color_mode}_umap_lowdose_v2.png")


def analysis(csv_paths, output_dir):
    """Main analysis function that loads data, processes it, and generates plots."""
    print("Analyzing data...")

    for csv_path in csv_paths:
        print(f"Processing {csv_path}...")
        data, features = load_data(csv_path)

        # Normalize label names
        data['ROI'] = data['ROI'].astype(str)

        # Extract method name from the file name (e.g., 'features_pyradiomics_full.csv' -> 'pyradiomics')
        method_name = os.path.basename(csv_path).split('_')[1]

        # Generate plots for ROI, Manufacturer, and Dose
        for color_mode in ['ROI', 'Dose']:
            plot_results(features, data[color_mode], data, color_mode, output_dir, filename_suffix=method_name)


if __name__ == "__main__":
    # Define file paths
    files_dir = '/mnt/nas7/data/maria/final_features'
    output_dir = '/mnt/nas7/data/maria/final_features/final_features_complete/umap/low_dose'

    os.makedirs(output_dir, exist_ok=True)

    csv_paths = [
    f'{files_dir}/ct-fm_low_dose/features_ct-fm_low_dose_v2.csv'
    ]
    
    # Run the analysis
    analysis(csv_paths, output_dir)


